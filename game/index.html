<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kundalini Invaders stable</title>
  <style>
    html, body { height: 100%; margin: 0; background: #000; color: #9eff6b; font-family: ui-monospace, Menlo, Consolas, monospace; }
    canvas { display: block; margin: 0 auto; background: #000; image-rendering: pixelated; image-rendering: crisp-edges; }
    .hud { position: fixed; top: 6px; left: 8px; display: flex; gap: 24px; font-weight: 700; letter-spacing: 1px; color: #9eff6b; }
  </style>
</head>
<body>
  <div class="hud">
    <div>SCORE <span id="score">0000</span></div>
    <div>LIVES <span id="lives">3</span></div>
    <div>LEVEL <span id="level">1</span></div>
  </div>
  <canvas id="game" width="224" height="256"></canvas>

  <script>
    const view = document.getElementById('game')
    const ctx = view.getContext('2d')
    ctx.imageSmoothingEnabled = false
    function fit() {
      const s = Math.floor(Math.min(innerWidth / 224, innerHeight / 256)) || 1
      view.style.width = 224 * s + 'px'
      view.style.height = 256 * s + 'px'
    }
    addEventListener('resize', fit)
    fit()

    const hudScore = document.getElementById('score')
    const hudLives = document.getElementById('lives')
    const hudLevel = document.getElementById('level')

    // constants
    const GRID_COLS = 11
    const GRID_ROWS = 5
    const CELL_W = 20
    const CELL_H = 18
    const SPRITE_W = 18
    const SPRITE_H = 18

    const H_SPEED = 8        // px per second formation
    const DROP = 8            // px on edge
    const PLAYER_SPEED = 60   // px per second
    const P_BULLET_SPEED = 120
    const E_BULLET_SPEED = 50
    const FIRE_GAP = 280      // ms

    const male = new Image()
    const female = new Image()
    male.src = 'men_yogi.png' // rename file accordingly
    female.src = 'woman_yogi.png' // rename file accordingly

    const keys = new Set()
    addEventListener('keydown', e => { if (e.code === 'Space') e.preventDefault(); keys.add(e.key) })
    addEventListener('keyup', e => keys.delete(e.key))

    const player = { x: 112, y: 232, w: 13, h: 8, alive: true, lastFire: 0 }
    let playerBullet = null

    const invaders = []
    const enemyBullets = []
    let formation = { x: 20, y: 48, dir: 1 }

    function resetFormation() {
      invaders.length = 0
      for (let r = 0; r < GRID_ROWS; r++) {
        for (let c = 0; c < GRID_COLS; c++) {
          invaders.push({
            col: c, row: r, alive: true,
            x: formation.x + c * CELL_W,
            y: formation.y + r * CELL_H,
            w: SPRITE_W, h: SPRITE_H,
            sex: (r % 2 === 0 ? 'male' : 'female')
          })
        }
      }
    })
        }
      }
    }

    let level = 1, score = 0, lives = 3
    function startLevel(n) {
      hudLevel.textContent = n
      formation = { x: 20, y: 48, dir: 1 }
      resetFormation()
      player.x = 112
      player.alive = true
      playerBullet = null
      enemyBullets.length = 0
    }
    startLevel(level)

    function aabb(a, b) {
      return Math.abs(a.x - b.x) * 2 < (a.w + b.w) && Math.abs(a.y - b.y) * 2 < (a.h + b.h)
    }

    let last = performance.now()
    let enemyFireTimer = 0
    function update() {
      const now = performance.now()
      const dt = Math.min(0.05, (now - last) / 1000)
      last = now

      // player
      if (keys.has('ArrowLeft') || keys.has('a') || keys.has('A')) player.x -= PLAYER_SPEED * dt
      if (keys.has('ArrowRight') || keys.has('d') || keys.has('D')) player.x += PLAYER_SPEED * dt
      player.x = Math.max(8, Math.min(224 - 8, player.x))

      if ((keys.has(' ') || keys.has('Space')) && !playerBullet && player.alive && now - player.lastFire > FIRE_GAP) {
        playerBullet = { x: player.x, y: player.y - 6, w: 1, h: 6, vy: -P_BULLET_SPEED }
        player.lastFire = now
      }
      if (playerBullet) {
        playerBullet.y += playerBullet.vy * dt
        if (playerBullet.y < 0) playerBullet = null
      }

      // formation
      const alive = invaders.filter(i => i.alive)
      if (alive.length) {
        const move = H_SPEED * dt * formation.dir
        for (const inv of alive) inv.x += move
        const leftMost = Math.min(...alive.map(i => i.x - i.w * 0.5))
        const rightMost = Math.max(...alive.map(i => i.x + i.w * 0.5))
        if (rightMost >= 224 - 8 && formation.dir === 1) { formation.dir = -1; for (const inv of alive) inv.y += DROP }
        if (leftMost <= 8 && formation.dir === -1) { formation.dir = 1; for (const inv of alive) inv.y += DROP }
      }

      // enemy fire every 0.9 s on average
      enemyFireTimer += dt
      if (enemyFireTimer > 0.9) {
        enemyFireTimer = 0
        const bottom = {}
        for (const inv of invaders) if (inv.alive) bottom[inv.col] = inv
        const cols = Object.keys(bottom)
        if (cols.length) {
          const shooter = bottom[cols[(Math.random()*cols.length)|0]]
          enemyBullets.push({ x: shooter.x, y: shooter.y + shooter.h * 0.5, w: 1, h: 6, vy: E_BULLET_SPEED })
        }
      }
      for (const eb of enemyBullets) eb.y += eb.vy * dt
      for (let i = enemyBullets.length - 1; i >= 0; i--) if (enemyBullets[i].y > 256) enemyBullets.splice(i,1)

      // collisions
      if (playerBullet) {
        for (const inv of invaders) if (inv.alive) {
          if (aabb({x:playerBullet.x,y:playerBullet.y,w:playerBullet.w,h:playerBullet.h}, inv)) {
            inv.alive = false
            playerBullet = null
            score += 10
            hudScore.textContent = String(score).padStart(4,'0')
            break
          }
        }
      }
      for (let i = enemyBullets.length - 1; i >= 0; i--) {
        const b = enemyBullets[i]
        if (aabb(b, player) && player.alive) {
          enemyBullets.splice(i,1)
          lives -= 1
          hudLives.textContent = lives
          player.alive = false
          setTimeout(()=>{ if (lives > 0) { player.alive = true; player.x = 112 } }, 600)
        }
      }

      if (!invaders.some(i => i.alive)) { level += 1; startLevel(level) }
      if (invaders.some(i => i.alive && i.y + i.h >= player.y)) { lives = 0; hudLives.textContent = lives }
    }

    function drawBackdrop() {
      ctx.fillStyle = '#000'
      ctx.fillRect(0, 0, 224, 256)
      ctx.fillStyle = '#9eff6b'
      ctx.fillRect(0, 244, 224, 1)
      ctx.fillStyle = '#f00'
      ctx.fillRect(110, 122, 4, 4)
    } {
      ctx.fillStyle = '#000'
      ctx.fillRect(0, 0, 224, 256)
      ctx.fillStyle = '#9eff6b'
      ctx.fillRect(0, 244, 224, 1)
      // debug marker to verify rendering
      ctx.fillStyle = '#f00'
      ctx.fillRect(110, 122, 4, 4)
    } {
      ctx.fillStyle = '#000'
      ctx.fillRect(0, 0, 224, 256)
      ctx.fillStyle = '#9eff6b'
      ctx.fillRect(0, 244, 224, 1)
    }

    function drawPlayer() {
      if (!player.alive) return
      ctx.fillStyle = '#9eff6b'
      ctx.fillRect(player.x - 6, player.y - 2, 12, 4)
      ctx.fillRect(player.x - 3, player.y - 6, 6, 4)
      ctx.fillRect(player.x - 1, player.y - 10, 2, 4)
    }

    function drawInvader(inv) {
      const img = inv.sex === 'male' ? male : female
      if ((inv.sex === 'male' && maleOk) || (inv.sex === 'female' && femaleOk)) {
        const dx = Math.round(inv.x - SPRITE_W * 0.5)
        const dy = Math.round(inv.y - SPRITE_H * 0.5)
        ctx.drawImage(img, dx, dy, SPRITE_W, SPRITE_H)
      } else {
        // placeholder so you still see the grid
        ctx.fillStyle = '#9eff6b'
        const dx = Math.round(inv.x - SPRITE_W * 0.5)
        const dy = Math.round(inv.y - SPRITE_H * 0.5)
        ctx.fillRect(dx, dy, SPRITE_W, SPRITE_H)
      }
    } {
      // integer pixel positions prevent shimmer
      const dx = Math.round(inv.x - SPRITE_W * 0.5)
      const dy = Math.round(inv.y - SPRITE_H * 0.5)
      ctx.drawImage(inv.sex === 'male' ? male : female, dx, dy, SPRITE_W, SPRITE_H)
    }

    function drawBullets() {
      ctx.fillStyle = '#fff'
      if (playerBullet) ctx.fillRect(playerBullet.x, playerBullet.y - 6, 1, 6)
      ctx.fillStyle = '#9eff6b'
      for (const b of enemyBullets) ctx.fillRect(b.x, b.y, 1, 6)
    }

    function frame() {
      update()
      drawBackdrop()
      for (const inv of invaders) if (inv.alive) drawInvader(inv)
      drawBullets()
      drawPlayer()
      requestAnimationFrame(frame)
    }

    frame()
  </script>
</body>
</html>
