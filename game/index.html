<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kundalini Invaders L1</title>
  <style>
    html, body { height: 100%; margin: 0; background: #050a12; color: #ffd54a; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .hud { position: fixed; top: 8px; left: 8px; display: flex; gap: 16px; align-items: center; font-weight: 700; letter-spacing: 1px; text-shadow: 0 2px 0 #000; }
    .panel { position: fixed; right: 8px; top: 8px; background: rgba(0,0,0,0.45); padding: 10px 12px; border-radius: 10px; color: #e6f3ff; font-size: 12px; }
    .panel label { display: block; margin-top: 6px; }
    .panel input[type="file"] { width: 210px; font-size: 11px; }
    .panel button, .panel select { margin-top: 6px; }
    canvas { display: block; margin: 0 auto; image-rendering: pixelated; }
  </style>
</head>
<body>
  <div class="hud">
    <div>Score: <span id="score">0000</span></div>
    <div>Level <span id="level">1</span></div>
  </div>

  <div class="panel">
    <div>Controls: A or left, D or right, space to fire, P to pause</div>
    <label>Sprite mode
      <select id="mode">
        <option value="sprites" selected>Sprites</option>
        <option value="ascii">ASCII</option>
      </select>
    </label>
    <label>Male yogi PNG
      <input id="male" type="file" accept="image/png,image/webp,image/jpeg" />
    </label>
    <label>Female yogi PNG
      <input id="female" type="file" accept="image/png,image/webp,image/jpeg" />
    </label>
    <button id="reset">Reset</button>
  </div>

  <canvas id="game" width="768" height="1152"></canvas>

  <script>
    const W = 768, H = 1152
    const canvas = document.getElementById('game')
    const ctx = canvas.getContext('2d')

    const hudScore = document.getElementById('score')
    const hudLevel = document.getElementById('level')
    const selMode = document.getElementById('mode')
    const inputMale = document.getElementById('male')
    const inputFemale = document.getElementById('female')
    const btnReset = document.getElementById('reset')

    const keys = new Set()
    let running = true

    const player = { x: W * 0.5, y: H - 90, w: 48, h: 36, speed: 6, cooldown: 0 }

    const bullets = []
    const enemies = []
    const stars = [...Array(250)].map(() => ({ x: Math.random()*W, y: Math.random()*H, z: Math.random()*1.5 + 0.5 }))

    let score = 0
    let level = 1

    const maleImg = new Image()
    const femaleImg = new Image()
    let maleReady = false
    let femaleReady = false

    // lightweight pixel fallback for sprites when no image is loaded
    function drawFallbackYogi(x, y, scale = 2, sex = 'male') {
      ctx.save()
      ctx.translate(x, y)
      ctx.scale(scale, scale)
      // base robe
      ctx.fillStyle = '#ffe8c8'
      ctx.fillRect(-12, -8, 24, 16)
      ctx.fillStyle = '#fff5dd'
      ctx.fillRect(-10, -18, 20, 14)
      // head
      ctx.fillStyle = '#c98a55'
      ctx.fillRect(-4, -28, 8, 8)
      // turban
      ctx.fillStyle = '#f7f1df'
      ctx.fillRect(-8, -36, 16, 8)
      // beard for male
      if (sex === 'male') {
        ctx.fillStyle = '#2b1b10'
        ctx.fillRect(-4, -22, 8, 4)
      }
      // pad
      ctx.fillStyle = '#d0c6a8'
      ctx.fillRect(-14, 8, 28, 3)
      ctx.restore()
    }

    function fileToImage(input, img, onready) {
      input.addEventListener('change', () => {
        const f = input.files && input.files[0]
        if (!f) return
        const url = URL.createObjectURL(f)
        img.onload = () => { URL.revokeObjectURL(url); onready(true) }
        img.onerror = () => onready(false)
        img.src = url
      })
    }

    fileToImage(inputMale, maleImg, ok => maleReady = ok)
    fileToImage(inputFemale, femaleImg, ok => femaleReady = ok)

    btnReset.addEventListener('click', () => init())

    document.addEventListener('keydown', e => {
      if (e.code === 'Space') keys.add('Space')
      else if (e.code === 'ArrowLeft' || e.key === 'a' || e.key === 'A') keys.add('Left')
      else if (e.code === 'ArrowRight' || e.key === 'd' || e.key === 'D') keys.add('Right')
      else if (e.key === 'p' || e.key === 'P') running = !running
    })
    document.addEventListener('keyup', e => {
      if (e.code === 'Space') keys.delete('Space')
      else if (e.code === 'ArrowLeft' || e.key === 'a' || e.key === 'A') keys.delete('Left')
      else if (e.code === 'ArrowRight' || e.key === 'd' || e.key === 'D') keys.delete('Right')
    })

    function init() {
      score = 0
      level = 1
      player.x = W * 0.5
      bullets.length = 0
      enemies.length = 0
      for (let i = 0; i < 12; i++) spawnEnemy()
      running = true
      loop(0)
    }

    function spawnEnemy() {
      const sex = Math.random() < 0.5 ? 'male' : 'female'
      const size = 44 + Math.random()*28
      enemies.push({
        x: 40 + Math.random()*(W - 80),
        y: -50 - Math.random()*500,
        w: size, h: size,
        vy: 1.2 + Math.random()*0.6 + level*0.1,
        sex,
        hp: 1
      })
    }

    function shoot() {
      if (player.cooldown > 0) return
      bullets.push({ x: player.x, y: player.y - 20, vy: -10 })
      player.cooldown = 10
    }

    function update(dt) {
      // background stars
      for (const s of stars) {
        s.y += s.z * 20 * dt
        if (s.y > H) { s.y = 0; s.x = Math.random()*W }
      }

      // player movement
      if (keys.has('Left')) player.x -= player.speed
      if (keys.has('Right')) player.x += player.speed
      player.x = Math.max(24, Math.min(W - 24, player.x))
      if (keys.has('Space')) shoot()
      if (player.cooldown > 0) player.cooldown -= 1

      // bullets
      for (const b of bullets) b.y += b.vy
      for (let i = bullets.length - 1; i >= 0; i--) if (bullets[i].y < -10) bullets.splice(i, 1)

      // enemies
      for (const e of enemies) e.y += e.vy
      // collisions
      for (let i = enemies.length - 1; i >= 0; i--) {
        const e = enemies[i]
        // off screen check
        if (e.y - e.h*0.5 > H) {
          enemies.splice(i, 1)
          spawnEnemy()
          continue
        }
        for (let j = bullets.length - 1; j >= 0; j--) {
          const b = bullets[j]
          if (Math.abs(b.x - e.x) < e.w*0.45 && Math.abs(b.y - e.y) < e.h*0.45) {
            bullets.splice(j, 1)
            e.hp -= 1
            if (e.hp <= 0) {
              enemies.splice(i, 1)
              score += 10
              if (score % 100 === 0) levelUp()
              spawnEnemy()
            }
            break
          }
        }
      }
      hudScore.textContent = String(score).padStart(4, '0')
      hudLevel.textContent = String(level)
    }

    function levelUp() {
      level += 1
      for (let i = 0; i < 2 + Math.min(6, level); i++) spawnEnemy()
    }

    function drawBackground() {
      ctx.fillStyle = '#050a12'
      ctx.fillRect(0, 0, W, H)
      // stars
      for (const s of stars) {
        const b = Math.floor(140 + s.z*70)
        ctx.fillStyle = `rgb(${b},${b},${b})`
        ctx.fillRect(s.x, s.y, 1, 1)
      }
    }

    function drawPlayer() {
      // simple green ship representing the player
      ctx.save()
      ctx.translate(player.x, player.y)
      ctx.fillStyle = '#19c37d'
      ctx.fillRect(-12, 8, 24, 6)
      ctx.fillRect(-8, 2, 16, 6)
      ctx.fillRect(-4, -8, 8, 12)
      ctx.restore()
    }

    function drawBullets() {
      ctx.fillStyle = '#ffe7a1'
      for (const b of bullets) ctx.fillRect(b.x - 2, b.y - 10, 4, 14)
    }

    function drawEnemy(e) {
      const mode = selMode.value
      const useMale = e.sex === 'male'
      const img = useMale ? maleImg : femaleImg
      const ready = useMale ? maleReady : femaleReady
      const w = e.w, h = e.h
      if (mode === 'sprites' && ready) {
        const scale = Math.min(w / img.width, h / img.height)
        const dw = img.width * scale
        const dh = img.height * scale
        ctx.drawImage(img, e.x - dw*0.5, e.y - dh*0.5, dw, dh)
      } else if (mode === 'ascii') {
        ctx.save()
        ctx.translate(e.x, e.y)
        ctx.fillStyle = '#ffe8c8'
        ctx.font = '16px monospace'
        ctx.textAlign = 'center'
        const lines = [
          '  o  ',
          ' /\\ ',
          '/__\\',
          ' | | '
        ]
        for (let i = 0; i < lines.length; i++) ctx.fillText(lines[i], 0, i*16)
        ctx.restore()
      } else {
        drawFallbackYogi(e.x, e.y, 2.1, e.sex)
      }
    }

    let last = 0
    function loop(ts) {
      if (!running) { requestAnimationFrame(loop); return }
      const dt = Math.min(0.035, (ts - last) / 1000)
      last = ts
      update(dt)
      drawBackground()
      drawPlayer()
      drawBullets()
      for (const e of enemies) drawEnemy(e)
      requestAnimationFrame(loop)
    }

    init()
  </script>
</body>
</html>
